<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TreeDelivery ‚Äì Weihnachtsbaum liefern lassen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --dark: #0A0F0A;
      --gold: #D8C27A;
      --gold-light: #FBEAB9;
      --soft: #EDE8D6;
      --error: #ff6b6b;
      --success: #7CFF93;
      --input-width: 90%;
      font-family: 'Inter', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--dark);
      color: var(--soft);
      line-height: 1.6;
      overflow-x: hidden;
      font-family: 'Inter', sans-serif;
    }

    [disabled] {
      opacity: 0.25 !important;
      pointer-events: none !important;
      cursor: not-allowed !important;
    }

    #snow-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    header {
      background: linear-gradient(140deg, #0B120C, #0F2A18, #0A0F0A);
      color: var(--gold-light);
      padding: 2rem 1.2rem 1.5rem;
      text-align: center;
      border-bottom-left-radius: 2rem;
      border-bottom-right-radius: 2rem;
      box-shadow: 0 10px 40px rgba(255,220,150,0.15);
    }

    header p {
      margin-top: 0.6rem;
      font-size: 0.95rem;
    }

    .glow {
      filter: drop-shadow(0 0 10px var(--gold-light));
    }

    main {
      padding: 0 1rem 2.5rem;
      max-width: 900px;
      margin: 0 auto;
    }

    .nav-tabs {
      display: flex;
      justify-content: center;
      margin: 2rem auto 1.4rem;
      max-width: 700px;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .nav-tabs button {
      flex: 1;
      min-width: 130px;
      padding: 0.85rem 1rem;
      border-radius: 999px;
      border: 2px solid var(--gold);
      background: transparent;
      color: var(--gold);
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s;
      font-size: 0.98rem;
    }

.bestseller-badge {
  position: absolute;
  top: 6px;
  right: 6px;
  background: linear-gradient(135deg, #d8c27a, #f4e5b7);
  color: #000;
  font-weight: 700;
  padding: 4px 10px;
  border-radius: 8px;
  font-size: 0.72rem;
  box-shadow: 0 0 10px rgba(216, 194, 122, 0.4);
  z-index: 5;
}

.tree-size-card[data-size="large"] {
  box-shadow:
    0 0 14px rgba(216, 194, 122, 0.32),
    0 0 26px rgba(216, 194, 122, 0.20);
  border-color: rgba(216,194,122,0.65);
}


	  
    .nav-tabs button.active {
      background: var(--gold);
      color: var(--dark);
      box-shadow: 0 0 18px var(--gold-light);
    }

    .card {
      background: rgba(15,26,15,0.9);
      border: 1px solid rgba(216,194,122,0.25);
      backdrop-filter: blur(6px);
      border-radius: 1.4rem;
      padding: 1.8rem 1.5rem 2rem;
      margin: 0 auto 1.6rem;
      max-width: 520px;
      overflow: hidden;
    }

    h2 {
      color: var(--gold-light);
      font-size: 1.6rem;
      margin-bottom: 1.2rem;
    }

    label {
      display: block;
      font-weight: 600;
      color: var(--gold-light);
      margin-top: 1rem;
      font-size: 0.98rem;
    }

    input, select, textarea {
      width: var(--input-width);
      max-width: 100%;
      padding: 0.8rem 0.9rem;
      border-radius: 0.7rem;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.05);
      color: var(--soft);
      font-size: 0.98rem;
      margin-top: .3rem;
      transition: 0.25s;
      font-family: inherit;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--gold);
      background: rgba(255,255,255,0.08);
      box-shadow: 0 0 10px rgba(255,255,160,0.25);
      outline: none;
      transform: translateY(-1px);
    }

    .btn {
      padding: 0.9rem 1.3rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.25s;
      margin-top: 1.2rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--gold);
      color: var(--dark);
      box-shadow: 0 0 18px rgba(255,215,130,0.5);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--gold-light);
      box-shadow: 0 0 25px rgba(255,235,160,0.7);
      transform: translateY(-2px);
    }

    .btn-ghost-danger {
      background: #552222;
      color: #ffbbbb;
      border: 1px solid rgba(255,187,187,0.5);
    }

    .btn-ghost-danger:hover:not(:disabled) {
      background: #773131;
      transform: translateY(-2px);
    }

    .toggle-container {
      margin-top: 1.3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
    }

    .toggle-label-text {
      font-size: 0.95rem;
    }

    .toggle {
      position: relative;
      width: 56px;
      height: 30px;
      flex-shrink: 0;
    }

    .toggle input { opacity: 0; width: 0; height: 0; }

    .slider {
      position: absolute;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background: rgba(255,255,255,0.15);
      border-radius: 20px;
      border: 1px solid var(--gold);
      transition: .3s;
    }

    .slider:before {
      content: "";
      position: absolute;
      width: 22px; height: 22px;
      left: 4px; bottom: 3px;
      background: var(--gold);
      border-radius: 50%;
      transition: .3s;
    }

    .toggle input:checked + .slider {
      background: var(--gold);
    }

    .toggle input:checked + .slider:before {
      transform: translateX(26px);
      background: var(--dark);
    }

    #date-wrapper,
    #special-wrapper,
    #edit-date-wrapper,
    #edit-special-wrapper {
      display: none;
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    #date-wrapper.visible,
    #special-wrapper.visible,
    #edit-date-wrapper.visible,
    #edit-special-wrapper.visible {
      display: block;
      opacity: 1;
    }

    .status {
      margin-top: 0.4rem;
      font-size: 0.85rem;
      min-height: 1.1rem;
    }

    #price-display {
      margin-top:1.2rem;
      font-size:1.1rem;
      color:var(--gold-light);
      font-weight:600;
    }

    #order-status {
      margin-top: 0.7rem;
      min-height: 1.2rem;
      font-size: 0.9rem;
    }

    .info-row {
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--gold-light);
      color: var(--gold-light);
      font-size: 0.7rem;
      cursor: pointer;
      flex-shrink: 0;
    }

    .info-box {
      margin-top: 0.25rem;
      padding: 0.6rem 0.7rem;
      border-radius: 0.7rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(216,194,122,0.35);
      font-size: 0.8rem;
      display: none;
    }

    .info-box.visible {
      display: block;
    }

    /* Popup-Overlay */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.visible {
      display: flex;
    }

    .modal {
      background: #151f15;
      border-radius: 1.4rem;
      border: 1px solid rgba(216,194,122,0.6);
      max-width: 420px;
      width: 90%;
      padding: 1.8rem 1.4rem 1.6rem;
      text-align: center;
      box-shadow: 0 20px 45px rgba(0,0,0,0.6);
      animation: pop-in 0.35s ease-out;
    }

    .modal h3 {
      margin-top: 0.4rem;
      margin-bottom: 0.4rem;
      font-size: 1.4rem;
      color: var(--gold-light);
    }

    .modal p {
      font-size: 0.95rem;
      margin: 0.2rem 0;
    }

    .modal-highlight {
      margin-top: 0.3rem;
      padding: 0.7rem 0.9rem;
      border-radius: 0.9rem;
      background: rgba(215,194,122,0.09);
      border: 1px solid rgba(216,194,122,0.5);
      font-size: 0.9rem;
    }

    .modal-id {
      font-family: "SF Mono", "Consolas", monospace;
      font-size: 1.05rem;
      letter-spacing: 0.03em;
      color: var(--gold-light);
    }

    .modal-glow {
      font-size: 2.1rem;
      animation: sway 1.8s ease-in-out infinite;
    }

    .modal-footer-text {
      font-size: 0.85rem;
      margin-top: 0.6rem;
      opacity: 0.9;
    }

    @keyframes pop-in {
      from {
        opacity: 0;
        transform: translateY(10px) scale(0.96);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes sway {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-6px);
      }
    }

    @media (max-width: 600px) {
      header {
        padding: 1.6rem 1rem 1.3rem;
      }

      header p {
        font-size: 0.9rem;
      }

      .card {
        padding: 1.6rem 1.2rem 1.8rem;
        border-radius: 1.2rem;
      }

      h2 {
        font-size: 1.4rem;
      }

      input, select, textarea {
        width: 100%;
        font-size: 0.95rem;
      }

      .btn {
        width: 100%;
        text-align: center;
      }

      .nav-tabs {
        gap: 0.5rem;
      }

      .nav-tabs button {
        font-size: 0.95rem;
        padding: 0.8rem 0.9rem;
      }

      .toggle-container {
        align-items: flex-start;
      }
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
    }
	  
/* Einheitliche Tab-H√∂hen */
#tab-bestellen,
#tab-meine-bestellung,
#tab-support {
  min-height: 520px;
}

@media (max-width: 600px) {
  #tab-bestellen,
  #tab-meine-bestellung,
  #tab-support {
    min-height: 480px;
  }
}

.tree-size-container {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  margin-top: 0.6rem;
}

.tree-size-card {
  position: relative;       /* ‚Üê WICHTIG! Jetzt geh√∂rt das Badge zur Karte */
  padding: 1rem 1.2rem;
  border-radius: 1rem;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(216,194,122,0.35);
  cursor: pointer;
  transition: 0.25s;
}

.tree-size-card:hover {
  background: rgba(216,194,122,0.15);
  transform: translateY(-2px);
}

.tree-size-card.selected {
  background: rgba(216,194,122,0.25);
  border-color: var(--gold);
  box-shadow: 0 0 18px rgba(216,194,122,0.4);
}

.tree-size-title {
  font-size: 1.05rem;
  color: var(--gold-light);
  font-weight: 600;
}

.tree-size-desc {
  font-size: 0.88rem;
  opacity: 0.85;
  margin-top: 0.2rem;
}

  </style>
</head>

<body>

<canvas id="snow-canvas"></canvas>

<header>
  <img src="logo.png" class="glow" style="max-width:260px;width:55%;" alt="TreeDelivery Logo">
  <p>Weihnachtsb√§ume bequem nach Hause geliefert</p>
</header>

<main>

  <div class="nav-tabs">
    <button class="active" data-tab="bestellen">üéÑ Baum bestellen</button>
    <button data-tab="meine-bestellung">üì¶ Meine Bestellung</button>
    <button data-tab="support">üí¨ Support</button>
  </div>

  <!-- BESTELLUNG -->
  <section id="tab-bestellen" class="card">
    <h2>üéÑ Baum bestellen</h2>
	  <form id="order-form">

<label>Baumgr√∂√üe *</label>


<div class="tree-size-container" id="tree-size-container">

  <!-- S -->
  <div class="tree-size-card" data-size="small">
    <div class="tree-size-title">
      S ‚Äì 1,2‚Äì1,5 m ‚Ä¢ <span class="tree-price" data-size="small"></span>
    </div>
    <div class="tree-size-desc">
      Nordmanntanne ‚Äì kompakt, ideal f√ºr kleinere R√§ume
    </div>
  </div>

  <!-- M -->
  <div class="tree-size-card" data-size="medium">
    <div class="tree-size-title">
      M ‚Äì 1,5‚Äì1,8 m ‚Ä¢ <span class="tree-price" data-size="medium"></span>
    </div>
    <div class="tree-size-desc">
      Nordmanntanne ‚Äì beliebteste Gr√∂√üe, passt √ºberall
    </div>
  </div>

  <!-- L (Bestseller) -->
  <div class="tree-size-card" data-size="large">
    <span class="bestseller-badge">Bestseller</span>
    <div class="tree-size-title">
      L ‚Äì 1,8‚Äì2,1 m ‚Ä¢ <span class="tree-price" data-size="large"></span>
    </div>
    <div class="tree-size-desc">
      Nordmanntanne ‚Äì gro√ü & beeindruckend
    </div>
  </div>

  <!-- XL -->
  <div class="tree-size-card" data-size="xl">
    <div class="tree-size-title">
      XL ‚Äì 2,1‚Äì2,6 m ‚Ä¢ <span class="tree-price" data-size="xl"></span>
    </div>
    <div class="tree-size-desc">
      Nordmanntanne ‚Äì extra gro√ü f√ºr hohe R√§ume
    </div>
  </div>

</div>
		  

<input type="hidden" id="size">
	  
      <label for="name">Name *</label>
      <input id="name" autocomplete="name" disabled>

      <label for="street">Stra√üe &amp; Hausnummer *</label>
      <input id="street" autocomplete="street-address" disabled>

      <label for="zip">PLZ *</label>
      <input id="zip" inputmode="numeric" pattern="[0-9]*" maxlength="5" disabled>
      <p id="zip-status" class="status"></p>

      <label for="city">Ort *</label>
      <input id="city" disabled>
      <p id="city-status" class="status"></p>

      <label for="email">E-Mail *</label>
      <input id="email" type="email" autocomplete="email" disabled>

      <label for="email-confirm">E-Mail best√§tigen *</label>
      <input id="email-confirm" type="email" autocomplete="email" disabled>

      <div class="toggle-container">
        <span class="toggle-label-text">Wunschtermin?</span>
        <label class="toggle">
          <input type="checkbox" id="date-toggle" disabled>
          <span class="slider"></span>
        </label>
      </div>

      <div id="date-wrapper">
        <label for="date">Lieferdatum</label>
        <input id="date" type="date" disabled>
        <p class="status" style="font-size:0.85rem;">
          Die genauen Lieferzeiten stehen in Ihrer Best√§tigungsmail.
        </p>
      </div>

      <div class="toggle-container">
        <span class="toggle-label-text">Spezielle W√ºnsche?</span>
        <label class="toggle">
          <input type="checkbox" id="special-toggle" disabled>
          <span class="slider"></span>
        </label>
      </div>

      <div id="special-wrapper">
        <label for="special-requests">Spezielle W√ºnsche</label>
        <textarea id="special-requests" placeholder="Zum Beispiel: Baum bereits angespitzt, bestimmte Uhrzeit-Spanne, Hinweise zur Haust√ºr ‚Ä¶" disabled></textarea>
      </div>

      <p id="price-display">Preis: ‚Äî</p>
      <p style="font-size:0.9rem; color:var(--gold); margin-top:0.3rem;">
        Die Bezahlung erfolgt bar bei Lieferung.
      </p>

      <button class="btn btn-primary" type="submit" id="order-btn" disabled>
        üéÅ Verbindlich bestellen
      </button>
      <p id="order-status" class="status"></p>
    </form>
  </section>

  <!-- MEINE BESTELLUNG -->
  <section id="tab-meine-bestellung" class="card" style="display:none;">
    <h2>üì¶ Meine Bestellung</h2>

    <form id="lookup-form">
      <label for="lookup-email">E-Mail *</label>
      <input id="lookup-email" type="email" autocomplete="email">

      <label for="lookup-id">
        <span class="info-row">
          <span>Kunden-ID *</span>
          <span class="info-icon" id="id-info-icon">i</span>
        </span>
      </label>
      <input id="lookup-id">
      <div id="id-info-box" class="info-box">
        Ihre Kunden-ID finden Sie in der Best√§tigungs-E-Mail, die Sie nach der Bestellung erhalten haben.
      </div>

      <button class="btn btn-primary" type="submit">Bestellung suchen</button>
      <p id="lookup-status" class="status"></p>
    </form>

    <div id="lookup-result" style="display:none; margin-top:1.5rem;"></div>
  </section>

  <!-- SUPPORT -->
  <section id="tab-support" class="card" style="display:none;">
    <h2>üí¨ Support</h2>
    <p>Bei Fragen schreiben Sie uns gerne:<br><br>
      <strong>kontakt@treedelivery.de</strong>
    </p>
  </section>

</main>

<!-- POPUP MODAL -->
<div id="order-modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-glow">üéÑ</div>
    <h3>Vielen Dank f√ºr Ihre Bestellung!</h3>

    <p id="modal-text-main">
      Wir haben Ihre Bestellung erfolgreich erhalten.
    </p>

    <div class="modal-highlight">
      <p><strong>Kunden-ID:</strong></p>
      <p id="modal-customer-id" class="modal-id"></p>

      <p style="margin-top:0.6rem; font-size:0.85rem;">
        Eine Best√§tigungs-E-Mail wurde an<br>
        <span id="modal-email" style="font-weight:600;"></span> gesendet.
      </p>
    </div>

    <p class="modal-footer-text">
      Sie k√∂nnen Ihre Bestellung jederzeit unter ‚ÄûMeine Bestellung‚Äú ansehen, anpassen oder stornieren.
    </p>

    <button id="modal-close-btn" class="btn btn-primary" type="button" style="margin-top:1rem;">
      Verstanden
    </button>
  </div>
</div>

<!-- LOGIK -->
<script>
const BACKEND_URL = "https://treedelivery-backend.onrender.com";
	let PRICE_DATA = null;

async function loadPrices() {
  const resp = await fetch(BACKEND_URL + "/prices");
  PRICE_DATA = await resp.json();

  document.querySelectorAll(".tree-price").forEach(span => {
    const size = span.dataset.size;
    if (PRICE_DATA[size]) {
      span.textContent = `${PRICE_DATA[size]}‚Ç¨`;
    }
  });
}

loadPrices();

// ------- ZIPS & ORTE -------
const allowedZips = [
  "57072","57074","57076","57078","57080",
  "57223","57234","57250","57258","57271",
  "57290","57299",
  "57319","57334","57339",
  "35708","35683","35684","35685",
  "35745","57555","57399","57610"
];

const zipToCity = {
  "57072": "Siegen",
  "57074": "Siegen",
  "57076": "Siegen",
  "57078": "Siegen",
  "57080": "Siegen",
  "57223": "Kreuztal",
  "57234": "Wilnsdorf",
  "57250": "Netphen",
  "57258": "Freudenberg",
  "57271": "Hilchenbach",
  "57290": "Neunkirchen",
  "57299": "Burbach",
  "57319": "Bad Berleburg",
  "57334": "Bad Laasphe",
  "57339": "Erndtebr√ºck",
  "35708": "Haiger",
  "35683": "Dillenburg",
  "35684": "Dillenburg",
  "35685": "Dillenburg",
  "35745": "Herborn",
  "57555": "Mudersbach",
  "57399": "Kirchhundem",
  "57610": "Altenkirchen"
};

function getCityByZip(zip) {
  return zipToCity[zip] || null;
}

function normalizeCity(str) {
  return (str || "").trim().toLowerCase();
}

function getTomorrowDateStr() {
  const today = new Date();
  today.setDate(today.getDate() + 1);
  const y = today.getFullYear();
  const m = String(today.getMonth() + 1).padStart(2, "0");
  const d = String(today.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

const MAX_DELIVERY_DATE = "2025-12-24";

document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll('.nav-tabs button');
  const tabs = {
    "bestellen": document.getElementById("tab-bestellen"),
    "meine-bestellung": document.getElementById("tab-meine-bestellung"),
    "support": document.getElementById("tab-support")
  };

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      Object.keys(tabs).forEach(key => {
        tabs[key].style.display = (btn.dataset.tab === key) ? "block" : "none";
      });
    });
  });

  setupInfoIcon();
  setupFormLogic();
  setupOrderSubmit();
  setupLookup();
  setupModal();
  setupSnow();
});

function setupInfoIcon() {
  const infoIcon = document.getElementById("id-info-icon");
  const infoBox = document.getElementById("id-info-box");
  if (!infoIcon || !infoBox) return;

  infoIcon.addEventListener("click", () => {
    infoBox.classList.toggle("visible");
  });
}

// ------- Formular-Logik Bestellung -------
function setupFormLogic() {

  const nameInput = document.getElementById("name");
  const size = document.getElementById("size");
  const street = document.getElementById("street");
  const zip = document.getElementById("zip");
  const city = document.getElementById("city");
  const email = document.getElementById("email");
  const emailConfirm = document.getElementById("email-confirm");
  const dateToggle = document.getElementById("date-toggle");
  const dateInput = document.getElementById("date");
  const dateWrapper = document.getElementById("date-wrapper");
  const specialToggle = document.getElementById("special-toggle");
  const specialWrapper = document.getElementById("special-wrapper");
  const specialTextarea = document.getElementById("special-requests");
  const orderBtn = document.getElementById("order-btn");
  const priceDisplay = document.getElementById("price-display");
  const zipStatus = document.getElementById("zip-status");
  const cityStatus = document.getElementById("city-status");

    // ------- Baumgr√∂√üen-Auswahlkarten -------
  const sizeCards = document.querySelectorAll(".tree-size-card");

  sizeCards.forEach(card => {
    card.addEventListener("click", () => {

      sizeCards.forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");

      const selectedSize = card.dataset.size;
      size.value = selectedSize;

      if (PRICE_DATA) {
        const price = PRICE_DATA[selectedSize] || "‚Äî";
        priceDisplay.textContent = `Preis: ${price}‚Ç¨`;
      }

      // Restliche Felder aktivieren
      nameInput.disabled = false;
    });
  });

  const minDate = getTomorrowDateStr();
  dateInput.setAttribute("min", minDate);
  dateInput.setAttribute("max", MAX_DELIVERY_DATE);

 size.addEventListener("change", () => {
  if (!PRICE_DATA) return;

  const val = size.value;
  const price = PRICE_DATA[val] || "‚Äî";
  priceDisplay.textContent = `Preis: ${price}‚Ç¨`;

  nameInput.disabled = !val;

  if (!val) {
    nameInput.value = "";
    street.value = "";
    zip.value = "";
    city.value = "";
    email.value = "";
    emailConfirm.value = "";
    street.disabled = true;
    const nameField = document.getElementById("name");
    nameField.disabled = true;
    zip.disabled = true;
    city.disabled = true;
    email.disabled = true;
    emailConfirm.disabled = true;
    dateToggle.checked = false;
    dateToggle.disabled = true;
    dateWrapper.classList.remove("visible");
    dateInput.disabled = true;
    dateInput.value = "";
    specialToggle.checked = false;
    specialToggle.disabled = true;
    specialWrapper.classList.remove("visible");
    specialTextarea.disabled = true;
    specialTextarea.value = "";
    orderBtn.disabled = true;
    zipStatus.textContent = "";
    cityStatus.textContent = "";
  }
});

  nameInput.addEventListener("input", () => {
    const val = nameInput.value.trim();
    street.disabled = val.length < 2;
  });

  street.addEventListener("input", () => {
    zip.disabled = street.value.trim() === "";
  });

  function validateZipAndCity() {
    const val = zip.value.trim();
    zipStatus.textContent = "";
    zipStatus.style.color = "var(--gold-light)";
    cityStatus.textContent = "";
    cityStatus.style.color = "var(--gold-light)";

    city.disabled = true;
    email.disabled = true;
    emailConfirm.disabled = true;
    emailConfirm.value = "";
    dateToggle.disabled = true;
    dateToggle.checked = false;
    dateWrapper.classList.remove("visible");
    dateInput.disabled = true;
    dateInput.value = "";
    specialToggle.disabled = true;
    specialToggle.checked = false;
    specialWrapper.classList.remove("visible");
    specialTextarea.disabled = true;
    specialTextarea.value = "";
    orderBtn.disabled = true;

    if (val.length < 5) {
      city.value = "";
      return;
    }

    if (!allowedZips.includes(val)) {
      city.value = "";
      zipStatus.textContent = "‚ùå Diese PLZ liegt au√üerhalb unseres Liefergebiets.";
      zipStatus.style.color = "var(--error)";
      return;
    }

    const expectedCity = getCityByZip(val);
    if (!expectedCity) {
      city.value = "";
      zipStatus.textContent = "‚ùå Zu dieser PLZ ist kein Ort hinterlegt.";
      zipStatus.style.color = "var(--error)";
      return;
    }

    city.disabled = false;
    city.value = expectedCity;
    cityStatus.textContent = "";
    email.disabled = false;
  }

  zip.addEventListener("input", validateZipAndCity);

  function revalidateCity() {
    const val = zip.value.trim();
    const currentCity = city.value.trim();
    const expected = getCityByZip(val);

    cityStatus.textContent = "";
    cityStatus.style.color = "var(--gold-light)";

    if (!val || !expected) {
      cityStatus.textContent = "";
      email.disabled = true;
      emailConfirm.disabled = true;
      orderBtn.disabled = true;
      dateToggle.disabled = true;
      specialToggle.disabled = true;
      return;
    }

    if (!currentCity) {
      cityStatus.textContent = "‚ùå Bitte geben Sie einen Ort ein.";
      cityStatus.style.color = "var(--error)";
      email.disabled = true;
      emailConfirm.disabled = true;
      orderBtn.disabled = true;
      dateToggle.disabled = true;
      specialToggle.disabled = true;
      return;
    }

    if (normalizeCity(expected) !== normalizeCity(currentCity)) {
      cityStatus.textContent = "‚ùå Ort passt nicht zur angegebenen PLZ.";
      cityStatus.style.color = "var(--error)";
      email.disabled = true;
      emailConfirm.disabled = true;
      orderBtn.disabled = true;
      dateToggle.disabled = true;
      specialToggle.disabled = true;
      return;
    }

    cityStatus.textContent = "";
    email.disabled = false;
  }

  city.addEventListener("input", revalidateCity);

  function isValidEmailFormat(mail) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mail);
  }

  email.addEventListener("input", () => {
    const mail = email.value.trim();

    if (isValidEmailFormat(mail)) {
      email.style.borderColor = "var(--gold)";
      emailConfirm.disabled = false;
    } else {
      email.style.borderColor = "rgba(255,0,0,0.5)";
      emailConfirm.disabled = true;
      emailConfirm.value = "";
      dateToggle.disabled = true;
      dateToggle.checked = false;
      dateWrapper.classList.remove("visible");
      dateInput.disabled = true;
      dateInput.value = "";
      specialToggle.disabled = true;
      specialToggle.checked = false;
      specialWrapper.classList.remove("visible");
      specialTextarea.disabled = true;
      specialTextarea.value = "";
      orderBtn.disabled = true;
    }
  });

  emailConfirm.addEventListener("input", () => {
    if (email.value === emailConfirm.value && email.value.trim() !== "") {
      dateToggle.disabled = false;
      specialToggle.disabled = false;
      orderBtn.disabled = false;
    } else {
      dateToggle.disabled = true;
      dateToggle.checked = false;
      dateWrapper.classList.remove("visible");
      dateInput.disabled = true;
      dateInput.value = "";
      specialToggle.disabled = true;
      specialToggle.checked = false;
      specialWrapper.classList.remove("visible");
      specialTextarea.disabled = true;
      specialTextarea.value = "";
      orderBtn.disabled = true;
    }
  });

  dateToggle.addEventListener("change", () => {
    const visible = dateToggle.checked;
    dateWrapper.classList.toggle("visible", visible);
    dateInput.disabled = !visible;
    if (!visible) {
      dateInput.value = "";
    } else {
      const todayMin = getTomorrowDateStr();
      dateInput.setAttribute("min", todayMin);
      dateInput.setAttribute("max", MAX_DELIVERY_DATE);
    }
  });

  specialToggle.addEventListener("change", () => {
    const visible = specialToggle.checked;
    specialWrapper.classList.toggle("visible", visible);
    specialTextarea.disabled = !visible;
    if (!visible) {
      specialTextarea.value = "";
    }
  });
}

// ------- Bestellung abschicken + Popup -------
function setupOrderSubmit() {
  const form = document.getElementById("order-form");
  const statusEl = document.getElementById("order-status");
  const orderBtn = document.getElementById("order-btn");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.style.color = "var(--gold-light)";
    statusEl.textContent = "Bestellung wird gesendet‚Ä¶";
    orderBtn.disabled = true;

    const name = document.getElementById("name").value.trim();
    const size = document.getElementById("size").value;
    const street = document.getElementById("street").value.trim();
    const zip = document.getElementById("zip").value.trim();
    const city = document.getElementById("city").value.trim();
    const email = document.getElementById("email").value.trim();
    const emailConfirm = document.getElementById("email-confirm").value.trim();
    const dateToggle = document.getElementById("date-toggle").checked;
    const date = document.getElementById("date").value || null;
    const specialToggle = document.getElementById("special-toggle").checked;
    const specialRequests = specialToggle ? document.getElementById("special-requests").value.trim() : null;

    if (!name || !size || !street || !zip || !city || !email || !emailConfirm) {
      statusEl.style.color = "var(--error)";
      statusEl.textContent = "Bitte f√ºllen Sie alle Pflichtfelder aus.";
      orderBtn.disabled = false;
      return;
    }

    if (email !== emailConfirm) {
      statusEl.style.color = "var(--error)";
      statusEl.textContent = "E-Mail-Adressen stimmen nicht √ºberein.";
      orderBtn.disabled = false;
      return;
    }

    if (dateToggle && date) {
      const min = getTomorrowDateStr();
      if (date < min) {
        statusEl.style.color = "var(--error)";
        statusEl.textContent = "Das Lieferdatum darf nicht fr√ºher als morgen liegen.";
        orderBtn.disabled = false;
        return;
      }
      if (date > MAX_DELIVERY_DATE) {
        statusEl.style.color = "var(--error)";
        statusEl.textContent = "Das Lieferdatum darf nicht nach dem 24.12.2025 liegen.";
        orderBtn.disabled = false;
        return;
      }
    }

    try {
      const resp = await fetch(BACKEND_URL + "/order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name,
          size,
          street,
          zip,
          city,
          email,
          date: dateToggle ? date : null,
          specialRequests: specialRequests || null
        })
      });

      const data = await resp.json();

      if (!resp.ok) {
        statusEl.style.color = "var(--error)";
        statusEl.textContent = data.error || "Fehler beim Speichern der Bestellung.";
        orderBtn.disabled = false;
        return;
      }

      statusEl.style.color = "var(--success)";
      statusEl.textContent = "Bestellung gespeichert. Eine Best√§tigung wurde per E-Mail versendet.";

      openOrderModal(data.customerId, email, date);

    } catch (err) {
      console.error(err);
      statusEl.style.color = "var(--error)";
      statusEl.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
      orderBtn.disabled = false;
    }
  });
}

// ------- Modal / Popup -------
function openOrderModal(customerId, email, date, updated = false) {
  const backdrop = document.getElementById("order-modal-backdrop");
  const idEl = document.getElementById("modal-customer-id");
  const mailEl = document.getElementById("modal-email");
  const mainText = document.getElementById("modal-text-main");
  const titleEl = document.querySelector(".modal h3");

  idEl.textContent = customerId || "‚Äî";
  mailEl.textContent = email || "Ihre E-Mail-Adresse";

  if (updated) {
    titleEl.textContent = "√Ñnderung gespeichert";
    mainText.textContent = "Ihre Bestellung wurde erfolgreich aktualisiert.";
  } else {
    titleEl.textContent = "Vielen Dank f√ºr Ihre Bestellung!";
    if (date) mainText.textContent = `Ihr Baum wird am ${date} geliefert.`;
    else mainText.textContent = "Ihr Baum wird in etwa zwei Tagen geliefert.";
  }

  backdrop.classList.add("visible");
}


// ------- Bestellung abrufen + bearbeiten/stornieren -------
function setupLookup() {
  const form = document.getElementById("lookup-form");
  const statusEl = document.getElementById("lookup-status");
  const resultEl = document.getElementById("lookup-result");

  let currentEmail = null;
  let currentCustomerId = null;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.style.color = "var(--gold-light)";
    statusEl.textContent = "Bestellung wird gesucht‚Ä¶";
    resultEl.style.display = "none";
    resultEl.innerHTML = "";

    const email = document.getElementById("lookup-email").value.trim();
    const customerId = document.getElementById("lookup-id").value.trim();

    if (!email || !customerId) {
      statusEl.style.color = "var(--error)";
      statusEl.textContent = "Bitte geben Sie E-Mail-Adresse und Kunden-ID ein.";
      return;
    }

    try {
      const resp = await fetch(BACKEND_URL + "/lookup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, customerId })
      });

      const data = await resp.json();

      if (!resp.ok) {
        statusEl.style.color = "var(--error)";
        statusEl.textContent = data.error || "Keine Bestellung gefunden.";
        return;
      }

      statusEl.style.color = "var(--success)";
      statusEl.textContent = "Bestellung gefunden.";

      currentEmail = data.email || email;
      currentCustomerId = data.customerId || customerId;

      const name = data.name || "";
      const size = data.size || "";
      const street = data.street || "";
      const zip = data.zip || "";
      const city = data.city || "";
      const date = data.date || "";
      const specialRequests = data.specialRequests || "";

      const minDate = getTomorrowDateStr();
      const safeDate = date ? new Date(date).toISOString().slice(0,10) : "";

      resultEl.innerHTML = `
        <div style="border-top:1px solid rgba(216,194,122,0.4); padding-top:1rem; margin-top:1rem;">
          <p style="font-size:0.9rem; color:var(--gold-light); margin-bottom:0.8rem;">
            Kunden-ID: <strong>${currentCustomerId}</strong><br>
            E-Mail: <strong>${currentEmail}</strong>
          </p>

          <label for="edit-name">Name</label>
          <input id="edit-name" value="${name.replace(/"/g, "&quot;")}" style="width:var(--input-width);">

          <label for="edit-size">Baumgr√∂√üe</label>
          <select id="edit-size" style="width:var(--input-width); margin-bottom:0.1rem;">
            <option value="small" ${size === "small" ? "selected" : ""}>S ‚Äì ca. 1,5 m ‚Äì 60‚Ç¨</option>
            <option value="medium" ${size === "medium" ? "selected" : ""}>M ‚Äì ca. 1,8 m ‚Äì 90‚Ç¨</option>
            <option value="large" ${size === "large" ? "selected" : ""}>L ‚Äì ca. 2,1 m ‚Äì 100‚Ç¨</option>
          </select>

          <label for="edit-street">Stra√üe &amp; Hausnummer</label>
          <input id="edit-street" value="${street.replace(/"/g, "&quot;")}" style="width:var(--input-width);">

          <label for="edit-zip">PLZ</label>
          <input id="edit-zip" value="${zip}" maxlength="5" style="width:var(--input-width);">
          <p id="edit-zip-status" class="status"></p>

          <label for="edit-city">Ort</label>
          <input id="edit-city" value="${city.replace(/"/g, "&quot;")}" style="width:var(--input-width);">
          <p id="edit-city-status" class="status"></p>

          <div class="toggle-container" style="margin-top:1.1rem;">
            <span class="toggle-label-text">Wunschtermin?</span>
            <label class="toggle">
              <input type="checkbox" id="edit-date-toggle">
              <span class="slider"></span>
            </label>
          </div>

          <div id="edit-date-wrapper">
            <label for="edit-date">Lieferdatum (optional)</label>
            <input id="edit-date" type="date" style="width:var(--input-width);">
          </div>

          <div class="toggle-container" style="margin-top:1.1rem;">
            <span class="toggle-label-text">Spezielle W√ºnsche?</span>
            <label class="toggle">
              <input type="checkbox" id="edit-special-toggle">
              <span class="slider"></span>
            </label>
          </div>

          <div id="edit-special-wrapper">
            <label for="edit-special">Spezielle W√ºnsche</label>
            <textarea id="edit-special" style="width:var(--input-width); min-height:80px;">${specialRequests ? String(specialRequests).replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""}</textarea>
          </div>

          <div style="margin-top:1.2rem; display:flex; gap:0.6rem; flex-wrap:wrap;">
            <button type="button" class="btn btn-primary" id="update-btn">√Ñnderungen speichern</button>
            <button type="button" class="btn btn-ghost-danger" id="delete-btn">
              Bestellung stornieren
            </button>
          </div>

          <p id="edit-status" class="status" style="margin-top:0.9rem;"></p>
        </div>
      `;

      resultEl.style.display = "block";

      const editZip = document.getElementById("edit-zip");
      const editCity = document.getElementById("edit-city");
      const editZipStatus = document.getElementById("edit-zip-status");
      const editCityStatus = document.getElementById("edit-city-status");
      const editDateToggle = document.getElementById("edit-date-toggle");
      const editDateWrapper = document.getElementById("edit-date-wrapper");
      const editDate = document.getElementById("edit-date");
      const editSpecialToggle = document.getElementById("edit-special-toggle");
      const editSpecialWrapper = document.getElementById("edit-special-wrapper");
      const editSpecialTextarea = document.getElementById("edit-special");

      editDate.setAttribute("min", minDate);
      editDate.setAttribute("max", MAX_DELIVERY_DATE);

      if (date) {
        editDateToggle.checked = true;
        editDateWrapper.classList.add("visible");
        editDate.value = safeDate;
        editDate.disabled = false;
      } else {
        editDateToggle.checked = false;
        editDateWrapper.classList.remove("visible");
        editDate.disabled = true;
      }

      if (specialRequests && String(specialRequests).trim() !== "") {
        editSpecialToggle.checked = true;
        editSpecialWrapper.classList.add("visible");
        editSpecialTextarea.disabled = false;
      } else {
        editSpecialToggle.checked = false;
        editSpecialWrapper.classList.remove("visible");
        editSpecialTextarea.disabled = true;
      }

      editDateToggle.addEventListener("change", () => {
        const visible = editDateToggle.checked;
        editDateWrapper.classList.toggle("visible", visible);
        editDate.disabled = !visible;
        if (!visible) {
          editDate.value = "";
        } else {
          const todayMin = getTomorrowDateStr();
          editDate.setAttribute("min", todayMin);
          editDate.setAttribute("max", MAX_DELIVERY_DATE);
        }
      });

      editSpecialToggle.addEventListener("change", () => {
        const visible = editSpecialToggle.checked;
        editSpecialWrapper.classList.toggle("visible", visible);
        editSpecialTextarea.disabled = !visible;
        if (!visible) {
          editSpecialTextarea.value = "";
        }
      });

      function validateEditZipAndCity() {
        const val = editZip.value.trim();
        editZipStatus.textContent = "";
        editCityStatus.textContent = "";
        editZipStatus.style.color = "var(--gold-light)";
        editCityStatus.style.color = "var(--gold-light)";

        if (val.length < 5) {
          editCity.value = "";
          return false;
        }

        if (!allowedZips.includes(val)) {
          editCity.value = "";
          editZipStatus.textContent = "‚ùå Diese PLZ liegt au√üerhalb unseres Liefergebiets.";
          editZipStatus.style.color = "var(--error)";
          return false;
        }

        const expectedCity = getCityByZip(val);
        if (!expectedCity) {
          editCity.value = "";
          editZipStatus.textContent = "‚ùå Zu dieser PLZ ist kein Ort hinterlegt.";
          editZipStatus.style.color = "var(--error)";
          return false;
        }

        if (!editCity.value.trim()) {
          editCity.value = expectedCity;
          return true;
        }

        if (normalizeCity(expectedCity) !== normalizeCity(editCity.value.trim())) {
          editCityStatus.textContent = "‚ùå Ort passt nicht zur angegebenen PLZ.";
          editCityStatus.style.color = "var(--error)";
          return false;
        }

        editZipStatus.textContent = "";
        editCityStatus.textContent = "";
        return true;
      }

      editZip.addEventListener("input", validateEditZipAndCity);
      editCity.addEventListener("input", validateEditZipAndCity);

      const updateBtn = document.getElementById("update-btn");
      const deleteBtn = document.getElementById("delete-btn");
      const editStatus = document.getElementById("edit-status");

      // UPDATE
      updateBtn.addEventListener("click", async () => {
        const newName = document.getElementById("edit-name").value.trim();
        const newSize = document.getElementById("edit-size").value;
        const newStreet = document.getElementById("edit-street").value.trim();
        const newZip = editZip.value.trim();
        const newCity = editCity.value.trim();
        const newDateToggle = editDateToggle.checked;
        const newDate = editDate.value || null;
        const newSpecialToggle = editSpecialToggle.checked;
        const newSpecial = newSpecialToggle ? editSpecialTextarea.value.trim() : null;

        if (!newSize || !newStreet || !newZip || !newCity) {
          editStatus.style.color = "var(--error)";
          editStatus.textContent = "Bitte f√ºllen Sie alle Pflichtfelder aus.";
          return;
        }

        if (!validateEditZipAndCity()) {
          editStatus.style.color = "var(--error)";
          editStatus.textContent = "Bitte pr√ºfen Sie PLZ und Ort.";
          return;
        }

        if (newDateToggle && newDate) {
          const min = getTomorrowDateStr();
          if (newDate < min) {
            editStatus.style.color = "var(--error)";
            editStatus.textContent = "Das Lieferdatum darf nicht fr√ºher als morgen liegen.";
            return;
          }
          if (newDate > MAX_DELIVERY_DATE) {
            editStatus.style.color = "var(--error)";
            editStatus.textContent = "Das Lieferdatum darf nicht nach dem 24.12.2025 liegen.";
            return;
          }
        }

        editStatus.style.color = "var(--gold-light)";
        editStatus.textContent = "√Ñnderungen werden gespeichert‚Ä¶";

        try {
          const respUpdate = await fetch(BACKEND_URL + "/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: currentEmail,
              customerId: currentCustomerId,
              name: newName || null,
              size: newSize,
              street: newStreet,
              zip: newZip,
              city: newCity,
              date: newDateToggle ? newDate : null,
              specialRequests: newSpecial || null
            })
          });

          const dataUpdate = await respUpdate.json();

          if (!respUpdate.ok) {
            editStatus.style.color = "var(--error)";
            editStatus.textContent = dataUpdate.error || "Fehler beim Aktualisieren.";
            return;
          }

          openOrderModal(currentCustomerId, currentEmail, newDate, true);

        } catch (err) {
          console.error(err);
          editStatus.style.color = "var(--error)";
          editStatus.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
        }
      });

      // DELETE
      deleteBtn.addEventListener("click", async () => {
        if (!confirm("M√∂chten Sie diese Bestellung wirklich stornieren?")) {
          return;
        }

        editStatus.style.color = "var(--gold-light)";
        editStatus.textContent = "Bestellung wird storniert‚Ä¶";

        try {
          const respDelete = await fetch(BACKEND_URL + "/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: currentEmail,
              customerId: currentCustomerId
            })
          });

          const dataDelete = await respDelete.json();

          if (!respDelete.ok) {
            editStatus.style.color = "var(--error)";
            editStatus.textContent = dataDelete.error || "Fehler beim Stornieren.";
            return;
          }

          editStatus.style.color = "var(--success)";
          editStatus.textContent = "Die Bestellung wurde storniert. Eine Best√§tigung wurde per E-Mail versendet.";
          setTimeout(() => {
            resultEl.style.display = "none";
            resultEl.innerHTML = "";
          }, 2500);

        } catch (err) {
          console.error(err);
          editStatus.style.color = "var(--error)";
          editStatus.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
        }
      });

    } catch (err) {
      console.error(err);
      statusEl.style.color = "var(--error)";
      statusEl.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
    }
  });
}

// ------- SCHNEE-ANIMATION -------
function setupSnow() {
  const canvas = document.getElementById("snow-canvas");
  if (!canvas || !canvas.getContext) return;
  const ctx = canvas.getContext("2d");

  function resize(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
  }
  resize();
  window.addEventListener("resize", resize);

  const snowflakeImage = new Image();
  snowflakeImage.src = "schneeflocke.png";

  let flakes = [];
  for(let i = 0; i < 120; i++){
    flakes.push({
      x: Math.random()*innerWidth,
      y: Math.random()*innerHeight,
      size: 8+Math.random()*10,
      speedY: 0.5+Math.random()*1.2,
      speedX: -0.5+Math.random(),
      rot: Math.random()*Math.PI*2,
      rotSpeed: -0.01+Math.random()*0.02
    });
  }

  function loop(){
    ctx.clearRect(0,0,innerWidth,innerHeight);
    flakes.forEach(f=>{
      f.y += f.speedY;
      f.x += f.speedX;
      f.rot += f.rotSpeed;

      if(f.y > innerHeight){ f.y = -f.size; f.x = Math.random()*innerWidth; }

      ctx.save();
      ctx.translate(f.x,f.y);
      ctx.rotate(f.rot);
      ctx.drawImage(snowflakeImage,-f.size/2,-f.size/2,f.size,f.size);
      ctx.restore();
    });
    requestAnimationFrame(loop);
  }
  snowflakeImage.onload = loop;
}
</script>

</body>
</html>
