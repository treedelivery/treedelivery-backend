<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TreeDelivery ‚Äì Weihnachtsbaum liefern lassen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --dark: #0A0F0A;
      --gold: #D8C27A;
      --gold-light: #FBEAB9;
      --soft: #EDE8D6;
      --input-width: 100%;
      font-family: 'Inter', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--dark);
      color: var(--soft);
      line-height: 1.6;
      overflow-x: hidden;
      font-family: 'Inter', sans-serif;
      font-size: 16px;
    }

    [disabled] {
      opacity: 0.25 !important;
      pointer-events: none !important;
      cursor: not-allowed !important;
    }

    #snow-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    header {
      background: linear-gradient(140deg, #0B120C, #0F2A18, #0A0F0A);
      color: var(--gold-light);
      padding: 1.8rem 1.2rem 1.6rem;
      text-align: center;
      border-bottom-left-radius: 2rem;
      border-bottom-right-radius: 2rem;
      box-shadow: 0 10px 40px rgba(255,220,150,0.15);
    }

    .glow {
      filter: drop-shadow(0 0 10px var(--gold-light));
    }

    header p {
      margin-top: 0.7rem;
      font-size: 0.95rem;
    }

    .nav-tabs {
      display: flex;
      justify-content: center;
      margin: 1.5rem auto 1rem;
      max-width: 700px;
      gap: 0.7rem;
      padding: 0 1rem;
    }

    .nav-tabs button {
      flex: 1;
      padding: 0.7rem 0.9rem;
      border-radius: 999px;
      border: 2px solid var(--gold);
      background: transparent;
      color: var(--gold);
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    .nav-tabs button.active {
      background: var(--gold);
      color: var(--dark);
      box-shadow: 0 0 18px var(--gold-light);
    }

    .card {
      background: rgba(15,26,15,0.9);
      border: 1px solid rgba(216,194,122,0.25);
      backdrop-filter: blur(6px);
      border-radius: 1.4rem;
      padding: 1.6rem 1.4rem 1.8rem;
      margin: 1rem auto 1.6rem;
      max-width: 520px;
      overflow: hidden;
      width: calc(100% - 2rem);
    }

    h2 {
      color: var(--gold-light);
      font-size: 1.4rem;
      margin-bottom: 1.1rem;
    }

    label {
      display: block;
      font-weight: 600;
      color: var(--gold-light);
      margin-top: 0.9rem;
      font-size: 0.95rem;
    }

    input,
    select,
    textarea {
      width: var(--input-width);
      padding: 0.8rem 0.9rem;
      border-radius: 0.7rem;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.05);
      color: var(--soft);
      font-size: 0.95rem;
      margin-top: 0.3rem;
      transition: 0.25s;
      font-family: inherit;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--gold);
      background: rgba(255,255,255,0.1);
      box-shadow: 0 0 10px rgba(255,255,160,0.25);
      outline: none;
      transform: translateY(-1px);
    }

    .btn {
      padding: 0.85rem 1.3rem;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: 0.25s;
      margin-top: 1rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--gold);
      color: var(--dark);
      box-shadow: 0 0 18px rgba(255,215,130,0.5);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--gold-light);
      box-shadow: 0 0 25px rgba(255,235,160,0.7);
      transform: translateY(-2px);
    }

    .toggle-container {
      margin-top: 1.3rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.7rem;
      font-size: 0.95rem;
    }

    .toggle {
      position: relative;
      width: 52px;
      height: 28px;
      flex-shrink: 0;
    }

    .toggle input { opacity: 0; width: 0; height: 0; }

    .slider {
      position: absolute;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background: rgba(255,255,255,0.15);
      border-radius: 20px;
      border: 1px solid var(--gold);
      transition: .3s;
    }

    .slider:before {
      content: "";
      position: absolute;
      width: 20px; height: 20px;
      left: 4px; bottom: 3px;
      background: var(--gold);
      border-radius: 50%;
      transition: .3s;
    }

    .toggle input:checked + .slider {
      background: var(--gold);
    }

    .toggle input:checked + .slider:before {
      transform: translateX(22px);
      background: var(--dark);
    }

    #date-wrapper,
    #edit-date-wrapper,
    #special-wrapper {
      display: none;
      opacity: 0;
      transition: 0.3s ease;
    }

    #date-wrapper.visible,
    #edit-date-wrapper.visible,
    #special-wrapper.visible {
      display: block;
      opacity: 1;
    }

    .status {
      margin-top: 0.4rem;
      font-size: 0.85rem;
    }

    #price-display {
      margin-top: 1.1rem;
      font-size: 1.1rem;
      color: var(--gold-light);
      font-weight: 600;
    }

    #order-status {
      margin-top: 0.7rem;
      min-height: 1.2rem;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
    }

    .info-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-top: 0.9rem;
    }

    .info-row label {
      margin-top: 0;
    }

    .info-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid var(--gold);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--gold-light);
      cursor: pointer;
      flex-shrink: 0;
      background: rgba(255,255,255,0.05);
    }

    #customer-id-hint {
      display: none;
      margin-top: 0.3rem;
      color: var(--soft);
    }

    /* Modal f√ºr Bestellbest√§tigung */
    #order-modal.modal-hidden {
      display: none;
    }

    #order-modal {
      position: fixed;
      inset: 0;
      z-index: 999;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal {
      background: rgba(15,26,15,0.97);
      border-radius: 1.5rem;
      padding: 1.7rem 1.6rem 1.9rem;
      max-width: 420px;
      width: 100%;
      text-align: center;
      border: 1px solid rgba(216,194,122,0.6);
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    }

    .modal-title {
      font-size: 1.4rem;
      color: var(--gold-light);
      margin-bottom: 0.6rem;
    }

    .modal-subtitle {
      font-size: 0.9rem;
      color: var(--soft);
      margin-bottom: 1.1rem;
    }

    .modal-highlight {
      font-weight: 700;
      color: var(--gold-light);
    }

    .modal-icon {
      font-size: 2.5rem;
      display: inline-block;
      margin-bottom: 0.7rem;
      animation: pop-in 0.8s ease-out forwards;
      transform-origin: center;
    }

    .modal-note {
      font-size: 0.85rem;
      margin-top: 0.9rem;
      color: var(--gold-light);
    }

    .btn-modal {
      margin-top: 1.3rem;
      width: 100%;
    }

    @keyframes pop-in {
      0% { transform: scale(0.3); opacity: 0; }
      60% { transform: scale(1.08); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 600px) {
      .nav-tabs {
        flex-direction: column;
        align-items: stretch;
      }
      .nav-tabs button {
        font-size: 0.95rem;
      }
      .card {
        padding: 1.4rem 1.2rem 1.6rem;
      }
      input,
      select,
      textarea {
        font-size: 1rem;
      }
      header p {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>

<canvas id="snow-canvas"></canvas>

<header>
  <img src="logo.png" class="glow" style="max-width:260px;width:55%;">
  <p>Weihnachtsb√§ume bequem nach Hause geliefert</p>
</header>

<main>

  <div class="nav-tabs">
    <button class="active" data-tab="bestellen">üéÑ Baum bestellen</button>
    <button data-tab="meine-bestellung">üì¶ Meine Bestellung</button>
    <button data-tab="support">üí¨ Support</button>
  </div>

  <!-- BESTELLUNG -->
  <section id="tab-bestellen" class="card">
    <h2>üéÑ Baum bestellen</h2>

    <form id="order-form">
      <label>Baumgr√∂√üe *</label>
      <select id="size">
        <option value="">Bitte w√§hlen‚Ä¶</option>
        <option value="small" data-price="60">S ‚Äì ca. 1,5 m ‚Äì 60‚Ç¨</option>
        <option value="medium" data-price="90">M ‚Äì ca. 1,8 m ‚Äì 90‚Ç¨</option>
        <option value="large" data-price="100">L ‚Äì ca. 2,1 m ‚Äì 100‚Ç¨</option>
      </select>

      <label>Name *</label>
      <input id="name" disabled>

      <label>Stra√üe & Hausnummer *</label>
      <input id="street" disabled>

      <label>PLZ *</label>
      <input id="zip" disabled>
      <p id="zip-status" class="status"></p>

      <label>Ort *</label>
      <input id="city" disabled>
      <p id="city-status" class="status"></p>

      <label>E-Mail *</label>
      <input id="email" type="email" disabled>

      <label>E-Mail best√§tigen *</label>
      <input id="email-confirm" type="email" disabled>
      <p id="email-status" class="status"></p>

      <div class="toggle-container">
        <span>Wunschtermin?</span>
        <label class="toggle">
          <input type="checkbox" id="date-toggle" disabled>
          <span class="slider"></span>
        </label>
      </div>

      <div id="date-wrapper">
        <label>Lieferdatum</label>
        <input id="date" type="date" disabled>
        <p class="status" style="font-size:0.85rem;">
          Die genauen Lieferzeiten stehen in Ihrer Best√§tigungsmail.
        </p>
      </div>

      <div class="toggle-container">
        <span>Spezielle W√ºnsche?</span>
        <label class="toggle">
          <input type="checkbox" id="special-toggle" disabled>
          <span class="slider"></span>
        </label>
      </div>

      <div id="special-wrapper">
        <label>Spezielle W√ºnsche (optional)</label>
        <textarea id="special-requests" disabled placeholder="Zum Beispiel: Bitte nach 17 Uhr liefern, Baum k√ºrzen, Zugang √ºber Hintereingang, ..."></textarea>
      </div>

      <p id="price-display">Preis: ‚Äî</p>
      <p style="font-size:0.9rem; color:var(--gold); margin-top:0.3rem;">
        Die Bezahlung erfolgt bar bei Lieferung.
      </p>

      <button class="btn btn-primary" type="submit" id="order-btn" disabled>
        üéÅ Verbindlich bestellen
      </button>
      <p id="order-status" class="status"></p>
    </form>
  </section>

  <!-- MEINE BESTELLUNG -->
  <section id="tab-meine-bestellung" class="card" style="display:none;">
    <h2>üì¶ Meine Bestellung</h2>

    <form id="lookup-form">
      <label>E-Mail *</label>
      <input id="lookup-email" type="email">

      <div class="info-row">
        <label for="lookup-id">Kunden-ID *</label>
        <div class="info-icon" id="customer-id-info">i</div>
      </div>
      <input id="lookup-id">

      <p id="customer-id-hint" class="status">
        Sie finden Ihre Kunden-ID in der E-Mail, die Sie nach Ihrer Bestellung erhalten haben.
        Bitte pr√ºfen Sie gegebenenfalls auch Ihren Spam- oder Werbungsordner.
      </p>

      <button class="btn btn-primary" type="submit">Bestellung suchen</button>
      <p id="lookup-status" class="status"></p>
    </form>

    <div id="lookup-result" style="display:none; margin-top:1.5rem;"></div>
  </section>

  <!-- SUPPORT -->
  <section id="tab-support" class="card" style="display:none;">
    <h2>üí¨ Support</h2>
    <p>Bei Fragen schreiben Sie uns gerne eine E-Mail: <br><br>
      <strong>kontakt@treedelivery.de</strong>
    </p>
  </section>

</main>

<!-- MODAL F√úR BESTELLBEST√ÑTIGUNG -->
<div id="order-modal" class="modal-hidden">
  <div class="modal-backdrop">
    <div class="modal">
      <div class="modal-icon">üéÑ</div>
      <div class="modal-title">Vielen Dank f√ºr Ihre Bestellung!</div>
      <div class="modal-subtitle">
        Ihre Kunden-ID lautet:<br>
        <span id="modal-customer-id" class="modal-highlight"></span><br><br>
        Die Best√§tigung wurde an<br>
        <span id="modal-email" class="modal-highlight"></span><br>
        gesendet.
      </div>
      <p class="modal-note">
        Bitte pr√ºfen Sie auch Ihren <strong>Spam- bzw. Werbungsordner</strong>,
        falls Sie keine E-Mail im Posteingang finden.
      </p>
      <button id="modal-close" class="btn btn-primary btn-modal">Fenster schlie√üen</button>
    </div>
  </div>
</div>

<!-- LOGIK -->
<script>
const BACKEND_URL = "https://treedelivery-backend.onrender.com";

// PLZ ‚Üí Ort Mapping
const zipToCity = {
  "57072": "Siegen",
  "57074": "Siegen",
  "57076": "Siegen",
  "57078": "Siegen",
  "57080": "Siegen",
  "57223": "Kreuztal",
  "57234": "Wilnsdorf",
  "57250": "Netphen",
  "57258": "Freudenberg",
  "57271": "Hilchenbach",
  "57290": "Neunkirchen",
  "57299": "Burbach",
  "57319": "Bad Berleburg",
  "57334": "Bad Laasphe",
  "57339": "Erndtebr√ºck",
  "57555": "Mudersbach",
  "57399": "Kirchhundem",
  "57610": "Altenkirchen",
  "35708": "Haiger",
  "35683": "Dillenburg",
  "35684": "Dillenburg",
  "35685": "Dillenburg",
  "35745": "Herborn"
};

function getCityByZip(zip) {
  return zipToCity[zip] || null;
}

function normalizeCity(str) {
  return (str || "").trim().toLowerCase();
}

function getTomorrowISO() {
  const d = new Date();
  d.setDate(d.getDate() + 1);
  d.setHours(0, 0, 0, 0);
  return d.toISOString().slice(0, 10);
}

// Hardcoded: 24.12.2025
function getMaxDateISO() {
  return "2025-12-24";
}

// ------- Tabs & Initialisierung -------
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll('.nav-tabs button');
  const tabs = {
    "bestellen": document.getElementById("tab-bestellen"),
    "meine-bestellung": document.getElementById("tab-meine-bestellung"),
    "support": document.getElementById("tab-support")
  };

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      Object.keys(tabs).forEach(key => {
        tabs[key].style.display = (btn.dataset.tab === key) ? "block" : "none";
      });
    });
  });

  // Modal schlie√üen
  const modalClose = document.getElementById("modal-close");
  if (modalClose) {
    modalClose.addEventListener("click", () => {
      document.getElementById("order-modal").classList.add("modal-hidden");
    });
  }

  // Info-Icon Kunden-ID
  const infoIcon = document.getElementById("customer-id-info");
  const idHint = document.getElementById("customer-id-hint");
  if (infoIcon && idHint) {
    infoIcon.addEventListener("click", () => {
      const isVisible = idHint.style.display === "block";
      idHint.style.display = isVisible ? "none" : "block";
    });
  }

  setupFormLogic();
  setupOrderSubmit();
  setupLookup();
});

// ------- ZIP Bereich -------
const allowedZips = [
  "57072","57074","57076","57078","57080",
  "57223","57234","57250","57258","57271",
  "57290","57299",
  "57319","57334","57339",
  "35708","35683","35684","35685",
  "35745","57555","57399","57610"
];

function openOrderModal(customerId, email) {
  const modal = document.getElementById("order-modal");
  document.getElementById("modal-customer-id").textContent = customerId;
  document.getElementById("modal-email").textContent = email;
  modal.classList.remove("modal-hidden");
}

function setupFormLogic() {
  const size = document.getElementById("size");
  const nameInput = document.getElementById("name");
  const street = document.getElementById("street");
  const zip = document.getElementById("zip");
  const city = document.getElementById("city");
  const email = document.getElementById("email");
  const emailConfirm = document.getElementById("email-confirm");
  const dateToggle = document.getElementById("date-toggle");
  const dateInput = document.getElementById("date");
  const dateWrapper = document.getElementById("date-wrapper");
  const specialToggle = document.getElementById("special-toggle");
  const specialWrapper = document.getElementById("special-wrapper");
  const specialInput = document.getElementById("special-requests");
  const orderBtn = document.getElementById("order-btn");
  const priceDisplay = document.getElementById("price-display");
  const zipStatus = document.getElementById("zip-status");
  const cityStatus = document.getElementById("city-status");
  const emailStatus = document.getElementById("email-status");

  let currentExpectedCity = null;

  // Datum-Grenzen setzen
  const dateMin = getTomorrowISO();
  const dateMax = getMaxDateISO();
  dateInput.min = dateMin;
  dateInput.max = dateMax;

  // Start: alles deaktiviert au√üer Gr√∂√üe
  nameInput.disabled = true;
  street.disabled = true;
  zip.disabled = true;
  city.disabled = true;
  email.disabled = true;
  emailConfirm.disabled = true;
  dateToggle.disabled = true;
  dateInput.disabled = true;
  orderBtn.disabled = true;
  specialToggle.disabled = true;
  specialInput.disabled = true;

  function resetAfterName() {
    street.value = "";
    street.disabled = true;

    zip.value = "";
    zip.disabled = true;
    zipStatus.textContent = "";
    zipStatus.style.color = "var(--gold-light)";

    city.value = "";
    city.disabled = true;
    cityStatus.textContent = "";
    cityStatus.style.color = "var(--gold-light)";
    city.style.borderColor = "";

    email.value = "";
    email.disabled = true;

    emailConfirm.value = "";
    emailConfirm.disabled = true;
    emailStatus.textContent = "";

    dateToggle.checked = false;
    dateToggle.disabled = true;

    dateInput.value = "";
    dateInput.disabled = true;
    dateWrapper.classList.remove("visible");

    specialToggle.checked = false;
    specialToggle.disabled = true;
    specialInput.value = "";
    specialInput.disabled = true;
    specialWrapper.classList.remove("visible");

    orderBtn.disabled = true;
  }

  function resetCityValidation() {
    cityStatus.textContent = "";
    cityStatus.style.color = "var(--gold-light)";
    city.style.borderColor = "";
  }

  function validateCity() {
    resetCityValidation();

    if (!currentExpectedCity) {
      return true;
    }

    const typed = normalizeCity(city.value);
    const expected = normalizeCity(currentExpectedCity);

    if (!typed) {
      cityStatus.textContent = "Bitte geben Sie den Ort ein.";
      cityStatus.style.color = "#ff6b6b";
      city.style.borderColor = "rgba(255,0,0,0.5)";
      return false;
    }

    if (typed !== expected) {
      cityStatus.textContent = `Der Ort passt nicht zur eingegebenen PLZ (erwartet: ‚Äû${currentExpectedCity}‚Äú).`;
      cityStatus.style.color = "#ff6b6b";
      city.style.borderColor = "rgba(255,0,0,0.5)";
      return false;
    }

    cityStatus.textContent = "";
    city.style.borderColor = "var(--gold)";
    return true;
  }

  // STEP 1: Gr√∂√üe w√§hlen
  size.onchange = () => {
    const selected = size.options[size.selectedIndex];
    const price = selected && selected.dataset.price ? selected.dataset.price : "‚Äî";
    priceDisplay.textContent = "Preis: " + price + "‚Ç¨";

    if (size.value) {
      nameInput.disabled = false;
    } else {
      nameInput.value = "";
      nameInput.disabled = true;
      resetAfterName();
    }
  };

  // STEP 2: Name
  nameInput.oninput = () => {
    const hasName = nameInput.value.trim() !== "";
    street.disabled = !hasName;

    if (!hasName) {
      resetAfterName();
    }
  };

  // STEP 3: Stra√üe
  street.oninput = () => {
    zip.disabled = street.value.trim() === "";
    if (zip.disabled) {
      zip.value = "";
      zipStatus.textContent = "";
      currentExpectedCity = null;

      city.value = "";
      city.disabled = true;
      resetCityValidation();

      email.value = "";
      email.disabled = true;

      emailConfirm.value = "";
      emailConfirm.disabled = true;
      emailStatus.textContent = "";

      dateToggle.checked = false;
      dateToggle.disabled = true;
      dateInput.value = "";
      dateInput.disabled = true;
      dateWrapper.classList.remove("visible");

      specialToggle.checked = false;
      specialToggle.disabled = true;
      specialInput.value = "";
      specialInput.disabled = true;
      specialWrapper.classList.remove("visible");

      orderBtn.disabled = true;
    }
  };

  // STEP 4: PLZ
  zip.oninput = () => {
    const val = zip.value.trim();

    zipStatus.textContent = "";
    zipStatus.style.color = "var(--gold-light)";

    currentExpectedCity = null;
    city.value = "";
    city.disabled = true;
    resetCityValidation();
    email.disabled = true;
    email.value = "";
    emailConfirm.value = "";
    emailConfirm.disabled = true;
    emailStatus.textContent = "";
    dateToggle.disabled = true;
    dateToggle.checked = false;
    dateInput.disabled = true;
    dateInput.value = "";
    dateWrapper.classList.remove("visible");
    specialToggle.disabled = true;
    specialToggle.checked = false;
    specialInput.disabled = true;
    specialInput.value = "";
    specialWrapper.classList.remove("visible");
    orderBtn.disabled = true;

    if (val.length < 5) {
      return;
    }

    if (!allowedZips.includes(val)) {
      zipStatus.textContent = "‚ùå Diese PLZ liegt au√üerhalb unseres Liefergebiets.";
      zipStatus.style.color = "#ff6b6b";
      return;
    }

    zipStatus.textContent = "‚úî Innerhalb unseres Liefergebiets.";
    zipStatus.style.color = "var(--gold-light)";

    const mappedCity = getCityByZip(val);
    currentExpectedCity = mappedCity;
    city.disabled = false;

    if (mappedCity) {
      city.value = mappedCity;
      validateCity();
      email.disabled = false;
    } else {
      city.value = "";
    }
  };

  // STEP 5: Ort
  city.oninput = () => {
    const ok = validateCity();
    if (!ok) {
      email.disabled = true;
      email.value = "";
      emailConfirm.value = "";
      emailConfirm.disabled = true;
      emailStatus.textContent = "";
      dateToggle.disabled = true;
      dateToggle.checked = false;
      dateInput.disabled = true;
      dateInput.value = "";
      dateWrapper.classList.remove("visible");
      specialToggle.disabled = true;
      specialToggle.checked = false;
      specialInput.disabled = true;
      specialInput.value = "";
      specialWrapper.classList.remove("visible");
      orderBtn.disabled = true;
      return;
    }

    email.disabled = false;
  };

  function isValidEmailFormat(mail) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(mail);
  }

  // STEP 6: E-Mail Format
  email.oninput = () => {
    const mail = email.value.trim();

    if (isValidEmailFormat(mail)) {
      email.style.borderColor = "var(--gold)";
      emailConfirm.disabled = false;
    } else {
      email.style.borderColor = "rgba(255,0,0,0.5)";
      emailConfirm.disabled = true;
      orderBtn.disabled = true;
      dateToggle.disabled = true;
      specialToggle.disabled = true;
      emailStatus.textContent = "";
    }
  };

  // STEP 7: E-Mails vergleichen
  emailConfirm.oninput = () => {
    const mail = email.value.trim();
    const mailConfirm = emailConfirm.value.trim();

    if (mail && mail === mailConfirm) {
      emailStatus.textContent = "‚úî E-Mail-Adresse best√§tigt.";
      emailStatus.style.color = "var(--gold-light)";
      dateToggle.disabled = false;
      specialToggle.disabled = false;
      orderBtn.disabled = false;
    } else {
      emailStatus.textContent = "‚ùå Die E-Mail-Adressen stimmen nicht √ºberein.";
      emailStatus.style.color = "#ff6b6b";
      dateToggle.disabled = true;
      specialToggle.disabled = true;
      orderBtn.disabled = true;
    }
  };

  // Wunschtermin Toggle
  dateToggle.onchange = () => {
    const visible = dateToggle.checked;
    dateWrapper.classList.toggle("visible", visible);
    dateInput.disabled = !visible;
  };

  // Spezielle W√ºnsche Toggle
  specialToggle.onchange = () => {
    const visible = specialToggle.checked;
    specialWrapper.classList.toggle("visible", visible);
    specialInput.disabled = !visible;
  };
}

// ------- Bestellung abschicken -------
function setupOrderSubmit() {
  const form = document.getElementById("order-form");
  const statusEl = document.getElementById("order-status");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.style.color = "var(--gold-light)";
    statusEl.textContent = "Bestellung wird gesendet‚Ä¶";

    const size = document.getElementById("size").value;
    const name = document.getElementById("name").value.trim();
    const street = document.getElementById("street").value.trim();
    const zip = document.getElementById("zip").value.trim();
    const city = document.getElementById("city").value.trim();
    const email = document.getElementById("email").value.trim();
    const emailConfirm = document.getElementById("email-confirm").value.trim();
    const dateToggle = document.getElementById("date-toggle").checked;
    const date = document.getElementById("date").value || null;
    const specialToggle = document.getElementById("special-toggle").checked;
    const specialRequests = document.getElementById("special-requests").value.trim();

    if (!size || !name || !street || !zip || !city || !email || !emailConfirm) {
      statusEl.style.color = "#ff6b6b";
      statusEl.textContent = "Bitte f√ºllen Sie alle Pflichtfelder aus.";
      return;
    }

    if (email !== emailConfirm) {
      statusEl.style.color = "#ff6b6b";
      statusEl.textContent = "Die E-Mail-Adressen stimmen nicht √ºberein.";
      return;
    }

    const expectedCity = getCityByZip(zip);
    if (!expectedCity || normalizeCity(expectedCity) !== normalizeCity(city)) {
      statusEl.style.color = "#ff6b6b";
      statusEl.textContent = "Der Ort passt nicht zur eingegebenen PLZ.";
      return;
    }

    const tomorrowStr = getTomorrowISO();
    const maxStr = getMaxDateISO();

    if (dateToggle && date) {
      if (date < tomorrowStr) {
        statusEl.style.color = "#ff6b6b";
        statusEl.textContent = "Das Lieferdatum darf nicht fr√ºher als morgen liegen.";
        return;
      }
      if (date > maxStr) {
        statusEl.style.color = "#ff6b6b";
        statusEl.textContent = "Das Lieferdatum darf nicht nach dem 24.12.2025 liegen.";
        return;
      }
    }

    try {
      const resp = await fetch(BACKEND_URL + "/order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          size,
          name,
          street,
          zip,
          city: expectedCity,
          email,
          date: dateToggle ? date : null,
          specialRequests: specialToggle && specialRequests ? specialRequests : null
        })
      });

      const data = await resp.json();

      if (!resp.ok) {
        statusEl.style.color = "#ff6b6b";
        statusEl.textContent = data.error || "Fehler beim Speichern der Bestellung.";
        return;
      }

      statusEl.style.color = "#7CFF93";
      statusEl.textContent = "Bestellung gespeichert.";
      openOrderModal(data.customerId, email);

    } catch (err) {
      console.error(err);
      statusEl.style.color = "#ff6b6b";
      statusEl.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
    }
  });
}

// ------- Bestellung abrufen + bearbeiten/stornieren -------
function setupLookup() {
  const form = document.getElementById("lookup-form");
  const statusEl = document.getElementById("lookup-status");
  const resultEl = document.getElementById("lookup-result");

  let currentEmail = null;
  let currentCustomerId = null;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.style.color = "var(--gold-light)";
    statusEl.textContent = "Bestellung wird gesucht‚Ä¶";
    resultEl.style.display = "none";
    resultEl.innerHTML = "";

    const email = document.getElementById("lookup-email").value.trim();
    const customerId = document.getElementById("lookup-id").value.trim();

    if (!email || !customerId) {
      statusEl.style.color = "#ff6b6b";
      statusEl.textContent = "Bitte geben Sie E-Mail-Adresse und Kunden-ID ein.";
      return;
    }

    try {
      const resp = await fetch(BACKEND_URL + "/lookup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, customerId })
      });

      const data = await resp.json();

      if (!resp.ok) {
        statusEl.style.color = "#ff6b6b";
        statusEl.textContent = data.error || "Keine Bestellung gefunden.";
        return;
      }

      statusEl.style.color = "#7CFF93";
      statusEl.textContent = "Bestellung gefunden.";

      currentEmail = data.email || email;
      currentCustomerId = data.customerId || customerId;

      const name = data.name || "";
      const size = data.size || "";
      const street = data.street || "";
      const zip = data.zip || "";
      const storedCity = data.city || "";
      const mappedCity = getCityByZip(zip) || storedCity;
      const date = data.date || "";
      const specialRequests = data.specialRequests || "";

      resultEl.innerHTML = `
        <div style="border-top:1px solid rgba(216,194,122,0.4); padding-top:1rem; margin-top:1rem;">
          <p style="font-size:0.9rem; color:var(--gold-light);">
            Kunden-ID: <strong>${currentCustomerId}</strong><br>
            Name: <strong>${name || "‚Äì"}</strong><br>
            E-Mail: <strong>${currentEmail}</strong>
          </p>

          <label>Baumgr√∂√üe</label>
          <select id="edit-size" style="margin-bottom:0.5rem;">
            <option value="small" ${size === "small" ? "selected" : ""}>S ‚Äì ca. 1,5 m ‚Äì 60‚Ç¨</option>
            <option value="medium" ${size === "medium" ? "selected" : ""}>M ‚Äì ca. 1,8 m ‚Äì 90‚Ç¨</option>
            <option value="large" ${size === "large" ? "selected" : ""}>L ‚Äì ca. 2,1 m ‚Äì 100‚Ç¨</option>
          </select>

          <label>Stra√üe & Hausnummer</label>
          <input id="edit-street" value="${street}" style="margin-bottom:0.5rem;">

          <label>PLZ</label>
          <input id="edit-zip" value="${zip}" style="margin-bottom:0.2rem;">
          <p id="edit-zip-status" class="status"></p>

          <label>Ort</label>
          <input id="edit-city" value="${mappedCity}" style="margin-bottom:0.2rem;">
          <p id="edit-city-status" class="status"></p>

          <div class="toggle-container" style="margin-top:1.1rem;">
            <span>Wunschtermin?</span>
            <label class="toggle">
              <input type="checkbox" id="edit-date-toggle">
              <span class="slider"></span>
            </label>
          </div>

          <div id="edit-date-wrapper">
            <label>Lieferdatum (optional)</label>
            <input id="edit-date" type="date" value="${date ? new Date(date).toISOString().slice(0,10) : ""}">
            <p class="status" style="font-size:0.85rem;">
              Die genauen Lieferzeiten stehen in Ihrer Best√§tigungsmail.
            </p>
          </div>

          <label style="margin-top:1.1rem;">Spezielle W√ºnsche (optional)</label>
          <textarea id="edit-special-requests" style="margin-top:0.3rem;">${specialRequests}</textarea>

          <div style="margin-top:1rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="button" class="btn btn-primary" id="update-btn">√Ñnderungen speichern</button>
            <button type="button" class="btn" id="delete-btn" style="background:#552222; color:#ffbbbb;">
              Bestellung stornieren
            </button>
          </div>

          <p id="edit-status" class="status" style="margin-top:0.8rem;"></p>
        </div>
      `;

      resultEl.style.display = "block";

      const updateBtn = document.getElementById("update-btn");
      const deleteBtn = document.getElementById("delete-btn");
      const editStatus = document.getElementById("edit-status");
      const editZip = document.getElementById("edit-zip");
      const editZipStatus = document.getElementById("edit-zip-status");
      const editCity = document.getElementById("edit-city");
      const editCityStatus = document.getElementById("edit-city-status");
      const editSize = document.getElementById("edit-size");
      const editStreet = document.getElementById("edit-street");
      const editDateToggle = document.getElementById("edit-date-toggle");
      const editDateWrapper = document.getElementById("edit-date-wrapper");
      const editDateInput = document.getElementById("edit-date");
      const editSpecialRequests = document.getElementById("edit-special-requests");

      // Datum-Grenzen
      const editDateMin = getTomorrowISO();
      const editDateMax = getMaxDateISO();
      editDateInput.min = editDateMin;
      editDateInput.max = editDateMax;

      // Initial Date-Toggle-Zustand
      if (date) {
        editDateToggle.checked = true;
        editDateWrapper.classList.add("visible");
        editDateInput.disabled = false;
      } else {
        editDateToggle.checked = false;
        editDateWrapper.classList.remove("visible");
        editDateInput.disabled = true;
      }

      function resetEditCityValidation() {
        editCityStatus.textContent = "";
        editCityStatus.style.color = "var(--gold-light)";
        editCity.style.borderColor = "";
      }

      function validateEditZipAndCity() {
        const val = editZip.value.trim();
        resetEditCityValidation();
        editZipStatus.textContent = "";
        editZipStatus.style.color = "var(--gold-light)";

        if (!val) {
          updateBtn.disabled = true;
          return false;
        }

        if (val.length < 5) {
          updateBtn.disabled = true;
          return false;
        }

        if (!allowedZips.includes(val)) {
          editZipStatus.textContent = "‚ùå Diese PLZ liegt au√üerhalb unseres Liefergebiets.";
          editZipStatus.style.color = "#ff6b6b";
          updateBtn.disabled = true;
          return false;
        }

        editZipStatus.textContent = "‚úî Innerhalb unseres Liefergebiets.";
        editZipStatus.style.color = "var(--gold-light)";

        const expected = getCityByZip(val);
        if (expected) {
          if (!editCity.value) {
            editCity.value = expected;
          }
          const typed = normalizeCity(editCity.value);
          const expNorm = normalizeCity(expected);

          if (typed !== expNorm) {
            editCityStatus.textContent = `Der Ort passt nicht zur eingegebenen PLZ (erwartet: ‚Äû${expected}‚Äú).`;
            editCityStatus.style.color = "#ff6b6b";
            editCity.style.borderColor = "rgba(255,0,0,0.5)";
            updateBtn.disabled = true;
            return false;
          } else {
    cityStatus.textContent = "";
    city.style.borderColor = "var(--gold)";
          }
        }

        updateBtn.disabled = false;
        return true;
      }

      editZip.addEventListener("input", validateEditZipAndCity);
      editCity.addEventListener("input", validateEditZipAndCity);
      validateEditZipAndCity();

      editDateToggle.addEventListener("change", () => {
        const visible = editDateToggle.checked;
        editDateWrapper.classList.toggle("visible", visible);
        editDateInput.disabled = !visible;
        if (!visible) {
          editDateInput.value = "";
        }
      });

      // UPDATE
      updateBtn.addEventListener("click", async () => {
        const newSize = editSize.value;
        const newStreet = editStreet.value.trim();
        const newZip = editZip.value.trim();
        const newCity = editCity.value.trim();
        const newDate = editDateInput.value || null;
        const newSpecial = editSpecialRequests.value.trim();

        if (!newSize || !newStreet || !newZip || !newCity) {
          editStatus.style.color = "#ff6b6b";
          editStatus.textContent = "Bitte f√ºllen Sie alle Pflichtfelder aus.";
          return;
        }

        const expectedCity = getCityByZip(newZip);
        if (!expectedCity || normalizeCity(expectedCity) !== normalizeCity(newCity)) {
          editStatus.style.color = "#ff6b6b";
          editStatus.textContent = "Der Ort passt nicht zur eingegebenen PLZ.";
          return;
        }

        const tomorrowStr = getTomorrowISO();
        const maxStr = getMaxDateISO();

        if (editDateToggle.checked && newDate) {
          if (newDate < tomorrowStr) {
            editStatus.style.color = "#ff6b6b";
            editStatus.textContent = "Das Lieferdatum darf nicht fr√ºher als morgen liegen.";
            return;
          }
          if (newDate > maxStr) {
            editStatus.style.color = "#ff6b6b";
            editStatus.textContent = "Das Lieferdatum darf nicht nach dem 24.12.2025 liegen.";
            return;
          }
        }

        editStatus.style.color = "var(--gold-light)";
        editStatus.textContent = "√Ñnderungen werden gespeichert‚Ä¶";

        try {
          const respUpdate = await fetch(BACKEND_URL + "/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: currentEmail,
              customerId: currentCustomerId,
              size: newSize,
              street: newStreet,
              zip: newZip,
              city: expectedCity,
              date: editDateToggle.checked ? newDate : null,
              specialRequests: newSpecial || null
            })
          });

          const dataUpdate = await respUpdate.json();

          if (!respUpdate.ok) {
            editStatus.style.color = "#ff6b6b";
            editStatus.textContent = dataUpdate.error || "Fehler beim Aktualisieren.";
            return;
          }

          editStatus.style.color = "#7CFF93";
          editStatus.textContent = "Bestellung aktualisiert. Sie erhalten in K√ºrze eine Best√§tigungsmail. Bitte pr√ºfen Sie auch Ihren Spam- bzw. Werbungsordner.";

        } catch (err) {
          console.error(err);
          editStatus.style.color = "#ff6b6b";
          editStatus.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
        }
      });

      // DELETE
      deleteBtn.addEventListener("click", async () => {
        if (!confirm("M√∂chten Sie diese Bestellung wirklich stornieren?")) {
          return;
        }

        editStatus.style.color = "var(--gold-light)";
        editStatus.textContent = "Bestellung wird storniert‚Ä¶";

        try {
          const respDelete = await fetch(BACKEND_URL + "/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: currentEmail,
              customerId: currentCustomerId
            })
          });

          const dataDelete = await respDelete.json();

          if (!respDelete.ok) {
            editStatus.style.color = "#ff6b6b";
            editStatus.textContent = dataDelete.error || "Fehler beim Stornieren.";
            return;
          }

          editStatus.style.color = "#7CFF93";
          editStatus.textContent = "Bestellung storniert. Sie erhalten in K√ºrze eine Best√§tigungsmail. Bitte pr√ºfen Sie auch Ihren Spam- bzw. Werbungsordner.";
          setTimeout(() => {
            resultEl.style.display = "none";
            resultEl.innerHTML = "";
          }, 2000);

        } catch (err) {
          console.error(err);
          editStatus.style.color = "#ff6b6b";
          editStatus.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
        }
      });

    } catch (err) {
      console.error(err);
      statusEl.style.color = "#ff6b6b";
      statusEl.textContent = "Der Server ist momentan nicht erreichbar. Bitte versuchen Sie es sp√§ter erneut.";
    }
  });
}
</script>

<!-- SCHNEE -->
<script>
const canvas = document.getElementById("snow-canvas");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
onresize = resize;

const snowflakeImage = new Image();
snowflakeImage.src = "schneeflocke.png";

let flakes = [];
for(let i=0;i<120;i++){
  flakes.push({
    x: Math.random()*innerWidth,
    y: Math.random()*innerHeight,
    size: 8+Math.random()*10,
    speedY: 0.5+Math.random()*1.2,
    speedX: -0.5+Math.random(),
    rot: Math.random()*Math.PI*2,
    rotSpeed: -0.01+Math.random()*0.02
  });
}

function loop(){
  ctx.clearRect(0,0,innerWidth,innerHeight);
  flakes.forEach(f=>{
    f.y += f.speedY;
    f.x += f.speedX;
    f.rot += f.rotSpeed;

    if(f.y > innerHeight){ f.y = -f.size; f.x = Math.random()*innerWidth; }

    ctx.save();
    ctx.translate(f.x,f.y);
    ctx.rotate(f.rot);
    ctx.drawImage(snowflakeImage,-f.size/2,-f.size/2,f.size,f.size);
    ctx.restore();
  });
  requestAnimationFrame(loop);
}
snowflakeImage.onload = loop;
</script>

</body>
</html>
